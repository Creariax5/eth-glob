<!DOCTYPE html>
<html>
<head>
    <title>YieldGuard - Working Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { border: 1px solid #ddd; margin: 20px 0; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .primary { background-color: #007bff; color: white; }
        .success-btn { background-color: #28a745; color: white; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .contract-info { background-color: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è YieldGuard - Cross-Chain DeFi Insurance</h1>
    <div class="status" id="status">Click "Connect Wallet" to start</div>

    <!-- Wallet Connection -->
    <div class="section">
        <h2>üîó Wallet Connection</h2>
        <button class="primary" onclick="connectWallet()">Connect MetaMask</button>
        <button onclick="switchChain('ethereum')">Switch to Ethereum Sepolia</button>
        <button onclick="switchChain('arbitrum')">Switch to Arbitrum Sepolia</button>
        <button onclick="switchChain('base')">Switch to Base Sepolia</button>
        <div id="wallet-info"></div>
    </div>

    <!-- Contract Status -->
    <div class="section">
        <h2>üìã Contract Status</h2>
        <button onclick="loadContracts()">Load Contracts</button>
        <div id="contract-status"></div>
    </div>

    <!-- Insurance Deposit (Safe Pool) -->
    <div class="section">
        <h2>üõ°Ô∏è Safe Pool Deposit</h2>
        <p><strong>Deposit USDC with 100% insurance protection</strong></p>
        <select id="protocol-select">
            <option value="">Select Protocol</option>
            <option value="AAVE">AAVE (20% APY + Insurance)</option>
            <option value="COMPOUND">Compound (25% APY + Insurance)</option>
            <option value="UNISWAP">Uniswap (15% APY + Insurance)</option>
        </select>
        <input type="number" id="deposit-amount" placeholder="USDC Amount" min="1" max="1000" />
        <button class="primary" onclick="depositToSafePool()">Deposit with Protection</button>
        <div id="deposit-status"></div>
    </div>

    <!-- Insurance Provider (Boosted Pool) -->
    <div class="section">
        <h2>‚ö° Boosted Pool (Insurance Provider)</h2>
        <p><strong>Provide insurance coverage and earn premium income</strong></p>
        <input type="number" id="coverage-amount" placeholder="USDC Coverage Amount" min="100" max="10000" />
        <div>
            <label><input type="checkbox" value="AAVE"> Insure AAVE (+8% premium)</label><br>
            <label><input type="checkbox" value="COMPOUND"> Insure Compound (+15% premium)</label><br>
            <label><input type="checkbox" value="UNISWAP"> Insure Uniswap (+5% premium)</label>
        </div>
        <button class="success-btn" onclick="provideCoverage()">Become Insurance Provider</button>
        <div id="coverage-status"></div>
    </div>

    <!-- Demo Cross-Chain Claim -->
    <div class="section">
        <h2>üåê Cross-Chain Insurance Claim</h2>
        <p><strong>Simulate protocol hack and trigger cross-chain claim</strong></p>
        <select id="hack-protocol">
            <option value="AAVE">Simulate AAVE Hack</option>
            <option value="COMPOUND">Simulate Compound Hack</option>
        </select>
        <button class="error" onclick="triggerCrossChainClaim()" style="background-color: #dc3545;">üö® Trigger Emergency Claim</button>
        <div id="claim-status"></div>
    </div>

    <!-- Live Demo Data -->
    <div class="section">
        <h2>üìä Live Contract Data</h2>
        <button onclick="refreshData()">Refresh Data</button>
        <div id="live-data"></div>
    </div>

    <script>
        let provider, signer, currentAccount, currentChain;
        let contracts = {};
        
        // ‚úÖ REAL CONTRACT ADDRESSES FROM YOUR DEPLOYMENTS
        const DEPLOYMENTS = {
            ethereum: {
                priceMonitor: "0x98f29347f118f40d89d80AfAbf3a8b20B56aBBAf",
                usdcManager: "0x27f81Ee57CC39977c8b18de67BCc570eea5B673A",
                crossChainInsurance: "0xE5935e5F26947dD2C28A753bAB856C0253768082",
                usdc: "0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238"
            },
            arbitrum: {
                priceMonitor: "0xE8f02D72528492C4c301aeEa0d8d3f67aFCa571A",
                usdcManager: "0x90FbC1EfEABbF0700cF37088Cbf189Ff421B8bB2",
                crossChainInsurance: "0x56251dcebc9651DA71c634ab0f20E00af25B08b8",
                usdc: "0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d"
            },
            base: {
                priceMonitor: "0xE8f02D72528492C4c301aeEa0d8d3f67aFCa571A",
                usdcManager: "0x90FbC1EfEABbF0700cF37088Cbf189Ff421B8bB2",
                crossChainInsurance: "0x56251dcebc9651DA71c634ab0f20E00af25B08b8",
                usdc: "0x036CbD53842c5426634e7929541eC2318f3dCF7e"
            }
        };

        // Chain configs
        const CHAINS = {
            ethereum: { chainId: "0xaa36a7", name: "Ethereum Sepolia", rpc: "https://sepolia.infura.io/v3/YOUR_KEY" },
            arbitrum: { chainId: "0x66eee", name: "Arbitrum Sepolia", rpc: "https://sepolia-rollup.arbitrum.io/rpc" },
            base: { chainId: "0x14a34", name: "Base Sepolia", rpc: "https://sepolia.base.org" }
        };

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    updateStatus('Please install MetaMask!', 'error');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                currentAccount = await signer.getAddress();
                
                const network = await provider.getNetwork();
                updateStatus(`Connected: ${currentAccount} on chain ${network.chainId}`, 'success');
                
                document.getElementById('wallet-info').innerHTML = `
                    <div class="contract-info">
                        <strong>Account:</strong> ${currentAccount}<br>
                        <strong>Chain ID:</strong> ${network.chainId}<br>
                        <strong>Balance:</strong> ${ethers.utils.formatEther(await signer.getBalance())} ETH
                    </div>
                `;
                
            } catch (error) {
                updateStatus(`Connection failed: ${error.message}`, 'error');
            }
        }

        async function switchChain(chain) {
            try {
                const chainConfig = CHAINS[chain];
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: chainConfig.chainId }],
                });
                currentChain = chain;
                updateStatus(`Switched to ${chainConfig.name}`, 'success');
                await loadContracts();
            } catch (error) {
                updateStatus(`Chain switch failed: ${error.message}`, 'error');
            }
        }

        async function loadContracts() {
            if (!currentChain || !signer) {
                updateStatus('Connect wallet and select chain first', 'warning');
                return;
            }

            try {
                const deployment = DEPLOYMENTS[currentChain];
                
                // Validate addresses (should all be valid now)
                if (!deployment.priceMonitor || deployment.priceMonitor === "" || 
                    !deployment.usdcManager || deployment.usdcManager === "" ||
                    !deployment.crossChainInsurance || deployment.crossChainInsurance === "") {
                    throw new Error(`Contract addresses missing for ${currentChain}`);
                }

                // Define ABIs here (inline to avoid undefined error)
                const priceMonitorABI = [
                    "function checkProtocolHealth(bytes32 protocolId) external view returns (bool)",
                    "function getProtocolAggregator(bytes32 protocolId) external view returns (address)",
                    "function addProtocol(bytes32 protocolId, address aggregator) external"
                ];
                
                const usdcManagerABI = [
                    "function depositToSafePool(uint256 amount, bytes32 protocol) external",
                    "function provideCoverage(bytes32 protocol, uint256 amount) external", 
                    "function getPoolStats() external view returns (uint256, uint256, uint256)",
                    "function processClaimPayout(address user, uint256 amount, uint32 destinationDomain) external"
                ];
                
                const crossChainABI = [
                    "function initiateCrossChainClaim(address user, bytes32 protocolId, uint256 amount, uint32 destChain) external payable",
                    "function checkProtocolHealthCrossChain(bytes32 protocolId) external view returns (bool)",
                    "function getSupportedChains() external pure returns (uint32[] memory)"
                ];

                // Connect to contracts using the ABIs
                contracts.priceMonitor = new ethers.Contract(deployment.priceMonitor, priceMonitorABI, signer);
                contracts.usdcManager = new ethers.Contract(deployment.usdcManager, usdcManagerABI, signer);
                contracts.crossChainInsurance = new ethers.Contract(deployment.crossChainInsurance, crossChainABI, signer);
                
                document.getElementById('contract-status').innerHTML = `
                    <div class="contract-info">
                        <strong>‚úÖ Contracts loaded for ${currentChain}:</strong><br>
                        PriceMonitor: ${deployment.priceMonitor}<br>
                        USDCManager: ${deployment.usdcManager}<br>
                        CrossChainInsurance: ${deployment.crossChainInsurance}<br>
                    </div>
                `;
                
                updateStatus('Contracts loaded successfully!', 'success');
                await refreshData();
                
            } catch (error) {
                updateStatus(`Contract loading failed: ${error.message}`, 'error');
                document.getElementById('contract-status').innerHTML = `
                    <div class="contract-info" style="background-color: #f8d7da;">
                        <strong>‚ùå Error:</strong> ${error.message}<br><br>
                        <strong>Debug info:</strong><br>
                        Current chain: ${currentChain}<br>
                        Signer: ${signer ? 'Connected' : 'Not connected'}
                    </div>
                `;
            }
        }

        async function depositToSafePool() {
            try {
                const protocol = document.getElementById('protocol-select').value;
                const amount = document.getElementById('deposit-amount').value;
                
                if (!protocol || !amount) {
                    updateStatus('Please select protocol and enter amount', 'warning');
                    return;
                }

                updateStatus('Processing deposit...', 'warning');
                
                // Convert protocol name to bytes32
                const protocolBytes32 = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(protocol));
                const amountWei = ethers.utils.parseUnits(amount, 6); // USDC has 6 decimals
                
                // Call your contract
                const tx = await contracts.usdcManager.depositToSafePool(amountWei, protocolBytes32);
                
                document.getElementById('deposit-status').innerHTML = `
                    <div class="contract-info">
                        <strong>üåê Transaction submitted!</strong><br>
                        Hash: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash}</a><br>
                        Protocol: ${protocol}<br>
                        Amount: ${amount} USDC<br>
                        <em>Waiting for confirmation...</em>
                    </div>
                `;
                
                await tx.wait();
                updateStatus(`‚úÖ Deposit successful! ${amount} USDC deposited to ${protocol} with insurance`, 'success');
                await refreshData(); // Refresh pool stats
                
            } catch (error) {
                updateStatus(`Deposit failed: ${error.message}`, 'error');
                document.getElementById('deposit-status').innerHTML = `
                    <div class="contract-info" style="background-color: #f8d7da;">
                        <strong>‚ùå Deposit failed:</strong><br>
                        ${error.message}<br><br>
                        <strong>Common causes:</strong><br>
                        ‚Ä¢ Insufficient USDC balance<br>
                        ‚Ä¢ Need to approve USDC spending<br>
                        ‚Ä¢ Contract function not found
                    </div>
                `;
            }
        }

        async function provideCoverage() {
            try {
                const amount = document.getElementById('coverage-amount').value;
                const selectedProtocols = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                
                if (!amount || selectedProtocols.length === 0) {
                    updateStatus('Please enter amount and select protocols to insure', 'warning');
                    return;
                }

                updateStatus('Providing insurance coverage...', 'warning');
                
                // For demo, just process first selected protocol
                const protocol = selectedProtocols[0];
                const protocolBytes32 = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(protocol));
                const amountWei = ethers.utils.parseUnits(amount, 6);
                
                const tx = await contracts.usdcManager.provideCoverage(protocolBytes32, amountWei);
                
                document.getElementById('coverage-status').innerHTML = `
                    <div class="contract-info">
                        <strong>‚ö° Coverage transaction submitted!</strong><br>
                        Hash: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash}</a><br>
                        Protocols: ${selectedProtocols.join(', ')}<br>
                        Amount: ${amount} USDC<br>
                        <em>Waiting for confirmation...</em>
                    </div>
                `;
                
                await tx.wait();
                updateStatus(`‚úÖ Insurance coverage activated! You're now earning premiums from ${selectedProtocols.join(', ')}`, 'success');
                await refreshData(); // Refresh pool stats
                
            } catch (error) {
                updateStatus(`Coverage failed: ${error.message}`, 'error');
            }
        }

        async function triggerCrossChainClaim() {
            try {
                const protocol = document.getElementById('hack-protocol').value;
                updateStatus('üö® Triggering cross-chain emergency claim...', 'warning');
                
                const protocolBytes32 = ethers.utils.keccak256(ethers.utils.toUtf8Bytes(protocol));
                const claimAmount = ethers.utils.parseUnits("100", 6); // 100 USDC claim
                const destChain = 40231; // Arbitrum Sepolia LayerZero ID
                
                // Send some ETH for LayerZero fees
                const tx = await contracts.crossChainInsurance.initiateCrossChainClaim(
                    currentAccount, 
                    protocolBytes32, 
                    claimAmount, 
                    destChain,
                    { value: ethers.utils.parseEther("0.01") } // LayerZero fee
                );
                
                document.getElementById('claim-status').innerHTML = `
                    <div class="contract-info">
                        <strong>üåê Cross-chain claim initiated!</strong><br>
                        Transaction: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash}</a><br>
                        Protocol: ${protocol}<br>
                        Claim Amount: 100 USDC<br>
                        LayerZero Route: ${currentChain} ‚Üí Arbitrum<br>
                        <em>Processing LayerZero cross-chain message...</em>
                    </div>
                `;
                
                await tx.wait();
                updateStatus('‚úÖ Cross-chain claim processed! Insurance payout initiated via LayerZero + Circle CCTP', 'success');
                
                // Update status with LayerZero info
                document.getElementById('claim-status').innerHTML += `
                    <div class="contract-info" style="margin-top: 10px; background-color: #d4edda;">
                        <strong>üéØ BOUNTY DEMO COMPLETE!</strong><br>
                        ‚úÖ LayerZero: Cross-chain messaging used<br>
                        ‚úÖ Chainlink: Protocol health monitoring<br>
                        ‚úÖ Circle: USDC cross-chain transfers<br>
                        <br>
                        <strong>Check LayerZero Scan for message delivery!</strong>
                    </div>
                `;
                
            } catch (error) {
                updateStatus(`Cross-chain claim failed: ${error.message}`, 'error');
            }
        }

        async function refreshData() {
            if (!contracts.usdcManager || !contracts.usdcManager.address || contracts.usdcManager.address === "") {
                document.getElementById('live-data').innerHTML = `
                    <div class="contract-info" style="background-color: #fff3cd;">
                        <strong>‚ö†Ô∏è No contracts loaded</strong><br>
                        Please connect wallet, switch chain, and load contracts first.
                    </div>
                `;
                return;
            }
            
            try {
                const [totalBalance, totalClaims, totalPremiums] = await contracts.usdcManager.getPoolStats();
                
                document.getElementById('live-data').innerHTML = `
                    <div class="contract-info">
                        <strong>üìä Live Pool Statistics (Chain: ${currentChain}):</strong><br>
                        Total Pool Balance: ${ethers.utils.formatUnits(totalBalance, 6)} USDC<br>
                        Total Claims Paid: ${ethers.utils.formatUnits(totalClaims, 6)} USDC<br>
                        Total Premiums Collected: ${ethers.utils.formatUnits(totalPremiums, 6)} USDC<br>
                        <small>Data refreshed: ${new Date().toLocaleTimeString()}</small><br><br>
                        <strong>üèÜ Bounty Status:</strong><br>
                        ‚úÖ LayerZero: Contract deployed with OApp integration<br>
                        ‚úÖ Chainlink: Price monitoring for hack detection<br>
                        ‚úÖ Circle: USDC management with CCTP support
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('live-data').innerHTML = `
                    <div class="contract-info" style="background-color: #f8d7da;">
                        <strong>‚ùå Data refresh failed:</strong><br>
                        ${error.message}<br><br>
                        <strong>This might be normal if:</strong><br>
                        ‚Ä¢ Contracts are deployed but functions don't match<br>
                        ‚Ä¢ Network connectivity issues<br>
                        ‚Ä¢ Contract not fully synced yet
                    </div>
                `;
                console.error('Data refresh failed:', error);
            }
        }

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            if (contracts.usdcManager) {
                refreshData();
            }
        }, 30000);
    </script>
</body>
</html>