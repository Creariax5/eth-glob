<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YieldGuard. - Premium DeFi Insurance</title>
    <link rel="icon" type="image/png" href="assets/icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="site/styles.css">
    <!-- Add Ethers.js for Web3 integration with fallback -->
    <script>
        // Load Ethers.js with fallback
        function loadEthers() {
            return new Promise((resolve, reject) => {
                // Try primary CDN
                const script1 = document.createElement('script');
                script1.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
                script1.onload = () => {
                    console.log('‚úÖ Ethers.js loaded from jsdelivr');
                    resolve();
                };
                script1.onerror = () => {
                    console.warn('‚ö†Ô∏è Primary CDN failed, trying backup...');
                    // Try backup CDN
                    const script2 = document.createElement('script');
                    script2.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
                    script2.onload = () => {
                        console.log('‚úÖ Ethers.js loaded from unpkg');
                        resolve();
                    };
                    script2.onerror = () => {
                        console.error('‚ùå Failed to load Ethers.js from all CDNs');
                        reject(new Error('Failed to load Ethers.js'));
                    };
                    document.head.appendChild(script2);
                };
                document.head.appendChild(script1);
            });
        }
    </script>
</head>
<body>
    <!-- Floating Background Elements -->
    <div class="floating-orb floating-orb-1"></div>
    <div class="floating-orb floating-orb-2"></div>
    <div class="floating-orb floating-orb-3"></div>

    <!-- Header -->
    <header class="header" id="header">
        <div class="header-container">
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-icon">
                        <span class="icon icon-shield"></span>
                    </div>
                    <div class="logo-text">
                        <h1>YieldGuard.</h1>
                    </div>
                </div>
                
                <nav class="nav">
                    <a href="index.html" class="nav-item active">
                        <span class="icon icon-chart"></span>
                        Overview
                    </a>
                    <a href="site/safepool.html" class="nav-item">
                        <span class="icon icon-shield"></span>
                        SafePool
                    </a>
                    <a href="site/boost.html" class="nav-item">
                        <span class="icon icon-zap"></span>
                        Boost
                    </a>
                    <a href="site/claims.html" class="nav-item">
                        <span class="icon icon-target"></span>
                        Claims
                    </a>
                </nav>
            </div>

            <div class="header-actions">
                <div class="chain-switcher">
                    <button class="chain-btn active" data-chain="ethereumSepolia">
                        <span class="chain-icon">‚ü®Œû‚ü©</span>
                        <span>Ethereum</span>
                    </button>
                    <button class="chain-btn" data-chain="arbitrumSepolia">
                        <span class="chain-icon">‚óÜ</span>
                        <span>Arbitrum</span>
                    </button>
                    <button class="chain-btn" data-chain="baseSepolia">
                        <span class="chain-icon">‚óá</span>
                        <span>Base</span>
                    </button>
                </div>
                
                <div class="wallet-section">
                    <div class="wallet-connected" id="wallet-connected" style="display: none;">
                        <div class="balance-info">
                            <div class="amount" id="usdc-balance">$0.00</div>
                            <div class="label">USDC Balance</div>
                        </div>
                        <div class="wallet-address">
                            <div class="wallet-status"></div>
                            <span id="wallet-address">0x0000...0000</span>
                        </div>
                    </div>
                    <button class="connect-btn" id="connect-wallet">
                        <span class="icon icon-wallet"></span>
                        <span>Connect Wallet</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="glass-container">
            <!-- Dashboard Page -->
            <div class="page active" id="dashboard">
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">Portfolio Overview</h1>
                        <p class="page-subtitle">Manage your cross-chain DeFi positions with premium insurance coverage</p>
                        <div class="page-actions">
                            <a href="site/safepool.html" class="btn btn-primary">
                                <span class="icon icon-shield"></span>
                                Start Investing
                            </a>
                            <a href="site/boost.html" class="btn btn-secondary">
                                <span class="icon icon-zap"></span>
                                Boost Yield
                            </a>
                        </div>
                    </div>

                    <button onclick="switchToSepolia()" class="btn btn-warning">Switch to Sepolia</button>

                    <!-- Connection Status -->
                    <div class="connection-status" id="connection-status" style="margin-bottom: 2rem;">
                        <div class="status-indicator" id="status-indicator">
                            <span class="status-dot"></span>
                            <span id="status-text">Connecting to contracts...</span>
                        </div>
                        <!-- Debug Info -->
                        <div class="debug-info" id="debug-info" style="margin-top: 1rem; font-size: 0.75rem; color: rgba(255,255,255,0.7);">
                            <div id="debug-text">Debug info will appear here...</div>
                            <button id="test-contracts-btn" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 0.25rem; cursor: pointer;">Test Contracts</button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon primary">
                                    <span class="icon icon-dollar"></span>
                                </div>
                                <div class="stat-info">
                                    <h3>Total Portfolio</h3>
                                    <div class="stat-value" id="total-portfolio">$0.00</div>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span class="stat-subtitle">Across 3 chains</span>
                                <div class="stat-trend positive">
                                    <span class="trend-arrow">‚Üó</span>
                                    <span>+8.5%</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon success">
                                    <span class="icon icon-shield"></span>
                                </div>
                                <div class="stat-info">
                                    <h3>Insured Value</h3>
                                    <div class="stat-value" id="insured-value">$0.00</div>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span class="stat-subtitle" id="coverage-percent">0% covered</span>
                                <div class="stat-trend positive">
                                    <span class="trend-arrow">‚Üó</span>
                                    <span>+2.1%</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon secondary">
                                    <span class="icon icon-trending"></span>
                                </div>
                                <div class="stat-info">
                                    <h3>Total Yield</h3>
                                    <div class="stat-value" id="total-yield">0%</div>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span class="stat-subtitle">Weighted APY</span>
                                <div class="stat-trend positive">
                                    <span class="trend-arrow">‚Üó</span>
                                    <span>+0.3%</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon warning">
                                    <span class="icon icon-sparkles"></span>
                                </div>
                                <div class="stat-info">
                                    <h3>Rewards</h3>
                                    <div class="stat-value" id="total-rewards">$0.00</div>
                                </div>
                            </div>
                            <div class="stat-footer">
                                <span class="stat-subtitle">This month</span>
                                <div class="stat-trend positive">
                                    <span class="trend-arrow">‚Üó</span>
                                    <span>+12.8%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="content-grid">
                        <div class="main-panel">
                            <div class="panel-header">
                                <h2 class="panel-title">Active Positions</h2>
                                <button class="panel-action" id="refresh-positions">Refresh</button>
                            </div>
                            
                            <div class="position-list" id="position-list">
                                <div class="position-item loading">
                                    <div class="position-content">
                                        <div class="loading-text">Loading positions...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="sidebar">
                            <div class="sidebar-card">
                                <h3 class="sidebar-title">Quick Actions</h3>
                                <a href="site/safepool.html" class="action-btn">
                                    <div class="action-left">
                                        <div class="action-icon safe">
                                            <span class="icon icon-shield"></span>
                                        </div>
                                        <span>Safe Pool</span>
                                    </div>
                                    <span class="icon icon-arrow arrow-icon"></span>
                                </a>
                                <a href="site/boost.html" class="action-btn">
                                    <div class="action-left">
                                        <div class="action-icon boost">
                                            <span class="icon icon-zap"></span>
                                        </div>
                                        <span>Boost Yield</span>
                                    </div>
                                    <span class="icon icon-arrow arrow-icon"></span>
                                </a>
                            </div>

                            <div class="sidebar-card">
                                <h3 class="sidebar-title">Protocol Health</h3>
                                <div class="protocol-grid" id="protocol-health">
                                    <div class="protocol-card loading">
                                        <div class="loading-text">Loading protocols...</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sidebar-card">
                                <h3 class="sidebar-title">Network Status</h3>
                                <div class="network-status" id="network-status">
                                    <div class="network-item">
                                        <span class="network-name">Ethereum</span>
                                        <span class="network-indicator" id="ethereum-status">üü°</span>
                                    </div>
                                    <div class="network-item">
                                        <span class="network-name">Arbitrum</span>
                                        <span class="network-indicator" id="arbitrum-status">üü°</span>
                                    </div>
                                    <div class="network-item">
                                        <span class="network-name">Base</span>
                                        <span class="network-indicator" id="base-status">üü°</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Load Contract ABIs (Generated from your compiled contracts) -->
    <script src="site/abis.js"></script>

    <!-- Global State and Contract Management -->
    <script>
        // Global application state
        window.YieldGuard = {
            currentChain: 'ethereumSepolia',
            provider: null,
            signer: null,
            contracts: {},
            deployments: {},
            userAddress: null,
            isConnected: false
        };

        // Chain configurations
        window.ChainConfigs = {
            ethereumSepolia: {
                chainId: '0xaa36a7',
                chainName: 'Ethereum Sepolia',
                displayName: 'Ethereum',
                rpcUrl: 'https://sepolia.infura.io/v3/YOUR_INFURA_KEY',
                blockExplorer: 'https://sepolia.etherscan.io'
            },
            arbitrumSepolia: {
                chainId: '0x66eeb',
                chainName: 'Arbitrum Sepolia',
                displayName: 'Arbitrum',
                rpcUrl: 'https://sepolia-rollup.arbitrum.io/rpc',
                blockExplorer: 'https://sepolia.arbiscan.io'
            },
            baseSepolia: {
                chainId: '0x14a34',
                chainName: 'Base Sepolia',
                displayName: 'Base',
                rpcUrl: 'https://sepolia.base.org',
                blockExplorer: 'https://sepolia.basescan.org'
            }
        };

        // Debug function
        function updateDebugInfo(message) {
            const debugText = document.getElementById('debug-text');
            if (debugText) {
                debugText.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
                debugText.scrollTop = debugText.scrollHeight;
            }
        }

        // Test contracts function
        async function testContracts() {
            if (!window.YieldGuard.contracts.usdcManager) {
                updateDebugInfo('‚ùå Contracts not initialized');
                return;
            }

            try {
                updateDebugInfo('üß™ Testing contract functions...');

                // Test USDCManager - use actual functions that exist
                if (window.YieldGuard.contracts.usdcManager) {
                    updateDebugInfo('üìû Testing USDCManager...');
                    
                    try {
                        // This should work - basic pool stats
                        const poolStats = await window.YieldGuard.contracts.usdcManager.getPoolStats();
                        updateDebugInfo(`‚úÖ Pool stats: [${poolStats.toString()}]`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå getPoolStats failed: ${error.message}`);
                        updateDebugInfo(`   Contract may need initialization or state setup`);
                    }

                    try {
                        // Test user deposits
                        const userDeposits = await window.YieldGuard.contracts.usdcManager.userDeposits(window.YieldGuard.userAddress);
                        updateDebugInfo(`‚úÖ User deposits: ${userDeposits.toString()}`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå userDeposits failed: ${error.message}`);
                    }

                    try {
                        // Test USDC token address
                        const usdcToken = await window.YieldGuard.contracts.usdcManager.usdcToken();
                        updateDebugInfo(`‚úÖ USDC token: ${usdcToken}`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå usdcToken failed: ${error.message}`);
                    }

                    try {
                        // Test domain constants
                        const ethDomain = await window.YieldGuard.contracts.usdcManager.ETHEREUM_DOMAIN();
                        const arbDomain = await window.YieldGuard.contracts.usdcManager.ARBITRUM_DOMAIN();
                        const baseDomain = await window.YieldGuard.contracts.usdcManager.BASE_DOMAIN();
                        updateDebugInfo(`‚úÖ Domains - ETH: ${ethDomain}, ARB: ${arbDomain}, BASE: ${baseDomain}`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå Domain constants failed: ${error.message}`);
                    }
                }

                // Test SimpleCrossChainInsurance - use functions that actually exist
                if (window.YieldGuard.contracts.crossChainInsurance) {
                    updateDebugInfo('üìû Testing SimpleCrossChainInsurance...');
                    
                    try {
                        // Test priceMonitor address - this should work
                        const priceMonitorAddr = await window.YieldGuard.contracts.crossChainInsurance.priceMonitor();
                        updateDebugInfo(`‚úÖ Price monitor address: ${priceMonitorAddr}`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå priceMonitor failed: ${error.message}`);
                    }

                    try {
                        // Test usdcManager address
                        const usdcManagerAddr = await window.YieldGuard.contracts.crossChainInsurance.usdcManager();
                        updateDebugInfo(`‚úÖ USDC manager address: ${usdcManagerAddr}`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå usdcManager failed: ${error.message}`);
                    }

                    try {
                        // Test getSupportedChains - this should work
                        const supportedChains = await window.YieldGuard.contracts.crossChainInsurance.getSupportedChains();
                        updateDebugInfo(`‚úÖ Supported chains: [${supportedChains.toString()}]`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå getSupportedChains failed: ${error.message}`);
                    }

                    try {
                        // Test user claim count
                        const claimCount = await window.YieldGuard.contracts.crossChainInsurance.userClaimCount(window.YieldGuard.userAddress);
                        updateDebugInfo(`‚úÖ User claim count: ${claimCount.toString()}`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå userClaimCount failed: ${error.message}`);
                    }

                    try {
                        // Test LayerZero endpoint
                        const lzEndpoint = await window.YieldGuard.contracts.crossChainInsurance.layerZeroEndpoint();
                        updateDebugInfo(`‚úÖ LayerZero endpoint: ${lzEndpoint}`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå layerZeroEndpoint failed: ${error.message}`);
                    }
                }

                // Test SimplePriceMonitor - use functions that actually exist
                if (window.YieldGuard.contracts.priceMonitor) {
                    updateDebugInfo('üìû Testing SimplePriceMonitor...');
                    
                    try {
                        // Test owner - this should work
                        const owner = await window.YieldGuard.contracts.priceMonitor.owner();
                        updateDebugInfo(`‚úÖ Contract owner: ${owner}`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå owner failed: ${error.message}`);
                    }

                    try {
                        // Test getProtocolAggregator with a sample protocol
                        const ethProtocolId = ethers.utils.keccak256(ethers.utils.toUtf8Bytes("ETH"));
                        const aggregator = await window.YieldGuard.contracts.priceMonitor.getProtocolAggregator(ethProtocolId);
                        updateDebugInfo(`‚úÖ ETH protocol aggregator: ${aggregator}`);
                        
                        if (aggregator === "0x0000000000000000000000000000000000000000") {
                            updateDebugInfo(`   No aggregator set for ETH protocol (expected on fresh deployment)`);
                        }
                    } catch (error) {
                        updateDebugInfo(`‚ùå getProtocolAggregator failed: ${error.message}`);
                    }

                    try {
                        // Test protocol status
                        const ethProtocolId = ethers.utils.keccak256(ethers.utils.toUtf8Bytes("ETH"));
                        const status = await window.YieldGuard.contracts.priceMonitor.protocolStatus(ethProtocolId);
                        updateDebugInfo(`‚úÖ ETH protocol status: ${status}`);
                    } catch (error) {
                        updateDebugInfo(`‚ùå protocolStatus failed: ${error.message}`);
                    }
                }

                updateDebugInfo('‚úÖ Contract testing complete');

            } catch (error) {
                updateDebugInfo(`‚ùå Contract test failed: ${error.message}`);
                console.error('Contract test error:', error);
            }
        }

        // Load deployment configurations
        async function loadDeployments() {
            try {
                const chains = ['ethereumSepolia', 'arbitrumSepolia', 'baseSepolia'];
                
                for (const chain of chains) {
                    try {
                        const response = await fetch(`./deployments/${chain}.json`);
                        if (response.ok) {
                            const deployment = await response.json();
                            window.YieldGuard.deployments[chain] = deployment;
                            console.log(`‚úÖ Loaded ${chain} deployment:`, deployment);
                            updateDebugInfo(`‚úÖ Loaded ${chain} deployment`);
                        } else {
                            console.warn(`‚ö†Ô∏è Could not load ${chain} deployment`);
                            updateDebugInfo(`‚ö†Ô∏è Could not load ${chain} deployment`);
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Error loading ${chain} deployment:`, error.message);
                        updateDebugInfo(`‚ö†Ô∏è Error loading ${chain}: ${error.message}`);
                    }
                }
                
                return Object.keys(window.YieldGuard.deployments).length > 0;
            } catch (error) {
                console.error('‚ùå Failed to load deployments:', error);
                updateDebugInfo(`‚ùå Failed to load deployments: ${error.message}`);
                return false;
            }
        }

        // Initialize contracts for current chain
        async function initializeContracts() {
            const currentDeployment = window.YieldGuard.deployments[window.YieldGuard.currentChain];
            
            if (!currentDeployment || !window.YieldGuard.signer) {
                console.log('‚ö†Ô∏è Missing deployment or signer for contract initialization');
                updateDebugInfo('‚ö†Ô∏è Missing deployment or signer');
                return false;
            }

            // Check if ABIs are loaded
            if (!window.ContractABIs) {
                console.error('‚ùå Contract ABIs not loaded');
                updateDebugInfo('‚ùå Contract ABIs not loaded - run extractABIs script');
                return false;
            }

            try {
                const contracts = currentDeployment.contracts;
                updateDebugInfo(`üîó Initializing contracts for ${window.YieldGuard.currentChain}`);
                updateDebugInfo(`üìã Contract addresses: ${JSON.stringify(contracts)}`);

                // Initialize contracts with correct names matching your artifacts
                window.YieldGuard.contracts = {};

                if (window.ContractABIs.SimplePriceMonitor && contracts.priceMonitor) {
                    window.YieldGuard.contracts.priceMonitor = new ethers.Contract(
                        contracts.priceMonitor,
                        window.ContractABIs.SimplePriceMonitor,  // Changed from PriceMonitor
                        window.YieldGuard.signer
                    );
                    updateDebugInfo('‚úÖ SimplePriceMonitor initialized');
                }

                if (window.ContractABIs.USDCManager && contracts.usdcManager) {
                    window.YieldGuard.contracts.usdcManager = new ethers.Contract(
                        contracts.usdcManager,
                        window.ContractABIs.USDCManager,
                        window.YieldGuard.signer
                    );
                    updateDebugInfo('‚úÖ USDCManager initialized');
                }

                if (window.ContractABIs.SimpleCrossChainInsurance && contracts.crossChainInsurance) {
                    window.YieldGuard.contracts.crossChainInsurance = new ethers.Contract(
                        contracts.crossChainInsurance,
                        window.ContractABIs.SimpleCrossChainInsurance,
                        window.YieldGuard.signer
                    );
                    updateDebugInfo('‚úÖ SimpleCrossChainInsurance initialized');
                }

                console.log('‚úÖ Contracts initialized for', window.YieldGuard.currentChain);
                updateDebugInfo(`‚úÖ All contracts initialized successfully`);
                return true;
            } catch (error) {
                console.error('‚ùå Failed to initialize contracts:', error);
                updateDebugInfo(`‚ùå Failed to initialize contracts: ${error.message}`);
                return false;
            }
        }

        // Connect wallet function
        async function connectWallet() {
            try {
                if (typeof window.ethers === 'undefined') {
                    throw new Error('Ethers.js not loaded. Please refresh the page.');
                }

                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask not installed');
                }

                updateDebugInfo('üîå Connecting wallet...');

                // Request account access
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                // Initialize provider and signer
                window.YieldGuard.provider = new ethers.providers.Web3Provider(window.ethereum);
                window.YieldGuard.signer = window.YieldGuard.provider.getSigner();
                window.YieldGuard.userAddress = accounts[0];
                window.YieldGuard.isConnected = true;

                updateDebugInfo(`‚úÖ Wallet connected: ${accounts[0]}`);

                // Initialize contracts
                await initializeContracts();

                // Update UI
                updateWalletUI();
                await updateDashboardData();

                console.log('‚úÖ Wallet connected:', accounts[0]);
                showNotification('Wallet connected successfully!', 'success');

                return accounts[0];
            } catch (error) {
                console.error('‚ùå Wallet connection failed:', error);
                updateDebugInfo(`‚ùå Wallet connection failed: ${error.message}`);
                showNotification(`Wallet connection failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Update wallet UI
        function updateWalletUI() {
            const connectBtn = document.getElementById('connect-wallet');
            const walletConnected = document.getElementById('wallet-connected');
            const walletAddress = document.getElementById('wallet-address');

            if (window.YieldGuard.isConnected && window.YieldGuard.userAddress) {
                // Hide connect button
                connectBtn.style.display = 'none';
                
                // Show connected wallet
                walletConnected.style.display = 'flex';
                
                // Update address
                const shortAddress = `${window.YieldGuard.userAddress.slice(0, 6)}...${window.YieldGuard.userAddress.slice(-4)}`;
                walletAddress.textContent = shortAddress;
                
                // Update connection status
                updateConnectionStatus('connected', 'Connected to contracts');
            } else {
                connectBtn.style.display = 'flex';
                walletConnected.style.display = 'none';
                updateConnectionStatus('disconnected', 'Not connected');
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(status, message) {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            if (statusIndicator && statusText) {
                statusIndicator.className = `status-indicator ${status}`;
                statusText.textContent = message;
            }
        }

        // Update dashboard with real data (with better error handling)
        async function updateDashboardData() {
            if (!window.YieldGuard.isConnected || !window.YieldGuard.contracts.usdcManager) {
                console.log('‚ö†Ô∏è Not connected or contracts not initialized');
                updateDebugInfo('‚ö†Ô∏è Not connected or contracts not initialized');
                return;
            }

            try {
                updateDebugInfo('üìä Updating dashboard data...');

                // Initialize default values
                let poolStats = [0, 0, 0]; // [totalBalance, totalClaims, totalPremiums]
                let userDeposits = ethers.BigNumber.from(0);
                let userCoverage = ethers.BigNumber.from(0);

                // Test USDCManager functions
                try {
                    updateDebugInfo('üìû Calling getPoolStats...');
                    poolStats = await window.YieldGuard.contracts.usdcManager.getPoolStats();
                    updateDebugInfo(`‚úÖ Pool stats received: ${poolStats.toString()}`);
                } catch (error) {
                    updateDebugInfo(`‚ùå getPoolStats failed: ${error.message}`);
                    updateDebugInfo(`   Using default values. Contract may need initialization.`);
                    // Continue with default values instead of throwing
                }

                try {
                    updateDebugInfo('üìû Calling userDeposits...');
                    userDeposits = await window.YieldGuard.contracts.usdcManager.userDeposits(window.YieldGuard.userAddress);
                    updateDebugInfo(`‚úÖ User deposits: ${userDeposits.toString()}`);
                } catch (error) {
                    updateDebugInfo(`‚ùå userDeposits failed: ${error.message}`);
                    userDeposits = ethers.BigNumber.from(0);
                }

                // Try to get user coverage - but this function doesn't exist in SimpleCrossChainInsurance
                // Instead, let's try to get coverage from USDCManager which has getUserCoverage(address, bytes32)
                try {
                    // Use a default protocol ID (ETH) to check coverage
                    const ethProtocolId = ethers.utils.keccak256(ethers.utils.toUtf8Bytes("ETH"));
                    updateDebugInfo('üìû Calling USDCManager.getUserCoverage...');
                    
                    // This should work - getUserCoverage exists in USDCManager
                    const coverage = await window.YieldGuard.contracts.usdcManager.getUserCoverage(
                        window.YieldGuard.userAddress, 
                        ethProtocolId
                    );
                    userCoverage = coverage.coverageAmount || ethers.BigNumber.from(0);
                    updateDebugInfo(`‚úÖ User coverage from USDCManager: ${userCoverage.toString()}`);
                } catch (error) {
                    updateDebugInfo(`‚ùå getUserCoverage failed: ${error.message}`);
                    updateDebugInfo(`   Note: This is expected if no coverage has been purchased yet`);
                    userCoverage = ethers.BigNumber.from(0);
                }

                // Update UI elements with proper error handling
                try {
                    // Update portfolio value (from user deposits)
                    const totalPortfolio = ethers.utils.formatUnits(userDeposits, 6); // USDC has 6 decimals
                    const insuredValue = ethers.utils.formatUnits(userCoverage, 6);
                    
                    // Update main dashboard values
                    const totalPortfolioElement = document.getElementById('total-portfolio');
                    const insuredValueElement = document.getElementById('insured-value');
                    const coveragePercentElement = document.getElementById('coverage-percent');
                    const usdcBalanceElement = document.getElementById('usdc-balance');

                    if (totalPortfolioElement) {
                        totalPortfolioElement.textContent = `$${parseFloat(totalPortfolio).toFixed(2)}`;
                    }

                    if (insuredValueElement) {
                        insuredValueElement.textContent = `$${parseFloat(insuredValue).toFixed(2)}`;
                    }

                    if (coveragePercentElement) {
                        // Calculate coverage percentage
                        const coveragePercent = userDeposits.gt(0) ? 
                            (userCoverage.mul(100).div(userDeposits)).toNumber() : 0;
                        coveragePercentElement.textContent = `${coveragePercent}% covered`;
                    }

                    // Update USDC balance in header
                    if (usdcBalanceElement) {
                        usdcBalanceElement.textContent = `$${parseFloat(totalPortfolio).toFixed(2)}`;
                    }

                    // Update pool stats if elements exist
                    const totalBalanceElement = document.getElementById('total-balance');
                    const totalClaimsElement = document.getElementById('total-claims');
                    const totalPremiumsElement = document.getElementById('total-premiums');

                    if (totalBalanceElement) {
                        totalBalanceElement.textContent = `${ethers.utils.formatUnits(poolStats[0] || 0, 6)} USDC`;
                    }

                    if (totalClaimsElement) {
                        totalClaimsElement.textContent = `${ethers.utils.formatUnits(poolStats[1] || 0, 6)} USDC`;
                    }

                    if (totalPremiumsElement) {
                        totalPremiumsElement.textContent = `${ethers.utils.formatUnits(poolStats[2] || 0, 6)} USDC`;
                    }

                    console.log('‚úÖ Dashboard data updated');
                    updateDebugInfo('‚úÖ Dashboard data updated successfully');
                    
                    // Show success message only if we got some real data
                    if (userDeposits.gt(0) || (poolStats[0] && ethers.BigNumber.from(poolStats[0]).gt(0))) {
                        showNotification('Dashboard updated with latest data', 'success');
                    } else {
                        showNotification('Dashboard updated (no deposits found)', 'info');
                    }

                } catch (uiError) {
                    updateDebugInfo(`‚ùå UI update failed: ${uiError.message}`);
                    console.error('UI update error:', uiError);
                }

            } catch (error) {
                console.error('‚ùå Failed to update dashboard data:', error);
                updateDebugInfo(`‚ùå Dashboard update failed: ${error.message}`);
                showNotification('Failed to load portfolio data. Check console for details.', 'error');
                
                // Set fallback values in UI
                try {
                    const elements = [
                        'total-portfolio',
                        'insured-value', 
                        'usdc-balance',
                        'total-balance',
                        'total-claims',
                        'total-premiums'
                    ];
                    
                    elements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = 'N/A';
                        }
                    });

                    const coverageElement = document.getElementById('coverage-percent');
                    if (coverageElement) {
                        coverageElement.textContent = '0% covered';
                    }
                } catch (fallbackError) {
                    console.error('Even fallback UI update failed:', fallbackError);
                }
            }
        }

        // Add this function to automatically switch to Sepolia
        async function switchToSepolia() {
            try {
                updateDebugInfo('üîÑ Attempting to switch to Sepolia...');
                
                // Try to switch to Sepolia
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xaa36a7' }], // 11155111 in hex
                });
                
                updateDebugInfo('‚úÖ Successfully switched to Sepolia!');
                showNotification('Switched to Sepolia network', 'success');
                
                // Reinitialize everything
                setTimeout(async () => {
                    await initializeContracts();
                    await updateDashboardData();
                }, 1000);
                
            } catch (switchError) {
                updateDebugInfo(`‚ùå Switch failed: ${switchError.message}`);
                
                // If the network doesn't exist, add it
                if (switchError.code === 4902) {
                    try {
                        updateDebugInfo('‚ûï Adding Sepolia network...');
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0xaa36a7',
                                chainName: 'Sepolia test network',
                                nativeCurrency: {
                                    name: 'ETH',
                                    symbol: 'ETH',
                                    decimals: 18,
                                },
                                rpcUrls: ['https://sepolia.infura.io/v3/'],
                                blockExplorerUrls: ['https://sepolia.etherscan.io'],
                            }],
                        });
                        
                        updateDebugInfo('‚úÖ Sepolia network added and switched!');
                        showNotification('Added and switched to Sepolia', 'success');
                        
                        // Reinitialize everything
                        setTimeout(async () => {
                            await initializeContracts();
                            await updateDashboardData();
                        }, 1000);
                        
                    } catch (addError) {
                        updateDebugInfo(`‚ùå Failed to add network: ${addError.message}`);
                        showNotification('Please manually switch to Sepolia in MetaMask', 'error');
                    }
                } else {
                    showNotification('Please manually switch to Sepolia in MetaMask', 'error');
                }
            }
        }

        // Add this function to your index.html to debug network issues
        async function debugNetworkInfo() {
            try {
                updateDebugInfo('üîç Debugging network information...');
                
                if (!window.YieldGuard.provider) {
                    updateDebugInfo('‚ùå No provider available');
                    return;
                }

                // Get network info from provider
                const network = await window.YieldGuard.provider.getNetwork();
                updateDebugInfo(`üì° Provider network: ${network.name} (chainId: ${network.chainId})`);
                
                // Get network from MetaMask directly
                const metamaskChainId = await window.ethereum.request({ method: 'eth_chainId' });
                updateDebugInfo(`ü¶ä MetaMask chainId: ${metamaskChainId} (decimal: ${parseInt(metamaskChainId, 16)})`);
                
                // Check if they match
                const expectedChainId = 11155111; // Sepolia
                const actualChainId = parseInt(metamaskChainId, 16);
                
                if (actualChainId === expectedChainId) {
                    updateDebugInfo('‚úÖ Network matches Sepolia!');
                } else {
                    updateDebugInfo(`‚ùå Network mismatch! Expected: ${expectedChainId}, Actual: ${actualChainId}`);
                    updateDebugInfo(`   Expected: Sepolia (11155111)`);
                    updateDebugInfo(`   Actual: ${getNetworkName(actualChainId)} (${actualChainId})`);
                }
                
                // Test a simple contract call with more details
                if (window.YieldGuard.contracts.usdcManager) {
                    updateDebugInfo('üß™ Testing simple contract call...');
                    try {
                        const code = await window.YieldGuard.provider.getCode(window.YieldGuard.contracts.usdcManager.address);
                        updateDebugInfo(`‚úÖ Contract code exists: ${code.length} characters`);
                        
                        // Try the call with explicit gas
                        const result = await window.YieldGuard.contracts.usdcManager.usdcToken({
                            gasLimit: 100000
                        });
                        updateDebugInfo(`‚úÖ usdcToken() call successful: ${result}`);
                        
                    } catch (error) {
                        updateDebugInfo(`‚ùå Contract call failed: ${error.message}`);
                        if (error.message.includes('network')) {
                            updateDebugInfo('   This looks like a network issue!');
                        }
                    }
                }
                
            } catch (error) {
                updateDebugInfo(`‚ùå Network debug failed: ${error.message}`);
            }
        }

        function getNetworkName(chainId) {
            const networks = {
                1: 'Ethereum Mainnet',
                11155111: 'Sepolia',
                421614: 'Arbitrum Sepolia', 
                84532: 'Base Sepolia',
                1337: 'Hardhat Local'
            };
            return networks[chainId] || 'Unknown Network';
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="notification-message">${message}</span>
                <button class="notification-close">&times;</button>
            `;

            // Add to page
            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);

            // Manual close
            notification.querySelector('.notification-close').onclick = () => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            };
        }

        // Initialize application
        async function initializeApp() {
            console.log('üöÄ Initializing YieldGuard DApp...');
            updateDebugInfo('üöÄ Initializing YieldGuard DApp...');
            
            // Update status
            updateConnectionStatus('loading', 'Loading dependencies...');
            
            // Wait for Ethers.js to load
            try {
                if (typeof window.ethers === 'undefined') {
                    console.log('üì¶ Loading Ethers.js...');
                    updateDebugInfo('üì¶ Loading Ethers.js...');
                    await loadEthers();
                }
                console.log('‚úÖ Ethers.js ready');
                updateDebugInfo('‚úÖ Ethers.js ready');
            } catch (error) {
                updateConnectionStatus('error', 'Failed to load Web3 dependencies');
                updateDebugInfo(`‚ùå Failed to load Ethers.js: ${error.message}`);
                showNotification('Failed to load required dependencies. Please refresh the page.', 'error');
                return;
            }
            
            // Check ABIs
            if (!window.ContractABIs) {
                updateConnectionStatus('error', 'Contract ABIs not loaded');
                updateDebugInfo('‚ùå Contract ABIs not loaded. Please run: node scripts/extractABIs.js');
                showNotification('Contract ABIs not found. Please run the ABI extraction script.', 'error');
                return;
            } else {
                updateDebugInfo(`‚úÖ Contract ABIs loaded: ${Object.keys(window.ContractABIs).join(', ')}`);
                // Check if we have the expected ABIs
                const expectedABIs = ['SimplePriceMonitor', 'USDCManager', 'SimpleCrossChainInsurance'];
                const missingABIs = expectedABIs.filter(name => !window.ContractABIs[name]);
                if (missingABIs.length > 0) {
                    updateDebugInfo(`‚ö†Ô∏è Missing ABIs: ${missingABIs.join(', ')}`);
                }
            }
            
            // Update status
            updateConnectionStatus('loading', 'Loading deployments...');
            
            // Load deployments
            const deploymentsLoaded = await loadDeployments();
            
            if (!deploymentsLoaded) {
                updateConnectionStatus('error', 'Failed to load contract deployments');
                updateDebugInfo('‚ùå Failed to load contract deployments');
                showNotification('Failed to load contract deployments. Please check if contracts are deployed.', 'error');
                return;
            }

            // Check if already connected
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        // Auto-connect if previously connected
                        await connectWallet();
                    } else {
                        updateConnectionStatus('ready', 'Ready to connect wallet');
                        updateDebugInfo('Ready to connect wallet');
                    }
                } catch (error) {
                    console.log('No previous connection found');
                    updateConnectionStatus('ready', 'Ready to connect wallet');
                    updateDebugInfo('No previous connection found');
                }
            } else {
                updateConnectionStatus('error', 'MetaMask not found');
                updateDebugInfo('‚ùå MetaMask not found');
                showNotification('Please install MetaMask to use YieldGuard', 'error');
            }

            // Setup event handlers
            setupEventHandlers();
            
            console.log('‚úÖ YieldGuard DApp initialized');
            updateDebugInfo('‚úÖ YieldGuard DApp initialized');
        }

        // Setup event handlers
        function setupEventHandlers() {
            // Connect wallet button
            document.getElementById('connect-wallet').addEventListener('click', connectWallet);

            // Test contracts button
            document.getElementById('test-contracts-btn').addEventListener('click', testContracts);

            // Chain switching
            document.querySelectorAll('.chain-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const newChain = this.dataset.chain;
                    
                    if (newChain !== window.YieldGuard.currentChain) {
                        window.YieldGuard.currentChain = newChain;
                        updateDebugInfo(`üîÑ Switching to ${newChain}`);
                        
                        // Update active button
                        document.querySelectorAll('.chain-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Reinitialize contracts and update data
                        if (window.YieldGuard.isConnected) {
                            await initializeContracts();
                            await updateDashboardData();
                        }
                        
                        showNotification(`Switched to ${this.textContent.trim()}`, 'success');
                    }
                });
            });

            // Refresh positions
            document.getElementById('refresh-positions').addEventListener('click', updateDashboardData);

            // MetaMask events
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.on('accountsChanged', function(accounts) {
                    if (accounts.length === 0) {
                        // User disconnected
                        window.YieldGuard.isConnected = false;
                        window.YieldGuard.userAddress = null;
                        updateWalletUI();
                        updateConnectionStatus('disconnected', 'Wallet disconnected');
                        updateDebugInfo('üîå Wallet disconnected');
                    } else {
                        // Account changed
                        window.YieldGuard.userAddress = accounts[0];
                        updateWalletUI();
                        updateDashboardData();
                        updateDebugInfo(`üîÑ Account changed to: ${accounts[0]}`);
                    }
                });

                window.ethereum.on('chainChanged', function(chainId) {
                    updateDebugInfo(`üîÑ Chain changed to: ${chainId}`);
                    // Reload page on chain change for simplicity
                    window.location.reload();
                });
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait a moment for any external scripts to load
            setTimeout(initializeApp, 100);
        });
    </script>

    <!-- Load the existing script.js for additional functionality -->
    <script src="site/script.js"></script>

    <!-- Additional CSS for new elements -->
    <style>
        .connection-status {
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-indicator .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #fbbf24;
        }

        .status-indicator.connected .status-dot {
            background: #10b981;
        }

        .status-indicator.error .status-dot {
            background: #ef4444;
        }

        .status-indicator.loading .status-dot {
            background: #3b82f6;
            animation: pulse 2s infinite;
        }

        .debug-info {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-family: monospace;
            text-align: left;
        }

        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 300px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            border-left-color: #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #fbbf24;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
        }

        .network-status {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .network-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .network-name {
            flex: 1;
        }

        .loading-text {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</body>
</html>